Neste capítulo são apresentados diversos recursos oferecidos pela infraestrutura do \openbus{} para o desenvolvimento de integrações de sistemas através de exemplos de código que utilizam a biblioteca de acesso do \openbus{}.
Todos os exemplos são elaborados de forma incremental para formar ao final uma integração completamente funcional sobre a infraestrutura do \openbus{}.

\section{OpenBus SDK}

O \openbus{} oferece um kit de desenvolvimento de software (SDK) com ferramentas para facilitar o desenvolvimento e integrações via \openbus{}.
O \openbus{} SDK é composto por:

\begin{itemize}
	\item Compilador de IDL.
	\item Biblioteca de acesso.
	\item Classes utilitárias.
	\item Documentação.
	\item Aplicações de demonstração.
\end{itemize}

O compilador de IDL disponibilizado é provido por pela implementação de ORB utilizada pelo SDK.
Por exemplo, no OpenBus SDK para Java o ORB utilizado é o JacORB.

O principal componente do SDK é a biblioteca de acesso.
Essa biblioteca permite a criação e utilização de ORB CORBA estendido com os recursos adicionais introduzidos pelo \openbus{}.
A principal função dessa biblioteca é facilitar o acesso a esses recursos particulares do \openbus{} através de uma API simples e flexível.

O SDK também inclui classes utilitárias para cenários de uso específicos do \openbus{}, tal como o \term{Assistente}, que automatiza tarefas rotineiras no caso de integrações mais simples.
O Assistente é discutido na seção \ref{sec:assistant}.

O SDK também inclui arquivos de documentação e aplicações de demonstração.

\section{Iniciando o ORB}

Um ORB OpenBus é iniciado através da operação \code{initORB}, cuja assinatura é apresentada baixo.

\begin{samplecode}
  public class ORBInitializer {
    public static ORB initORB();
    public static ORB initORB(String[] args);
    public static ORB initORB(String[] args, Properties props);
  }
\end{samplecode}

A operação \code{initORB} tem o mesmo funcionamento da operação \code{CORBA::init} do padrão CORBA, exceto que ela inicia e retorna um ORB com os recursos adicionais do \openbus{}.
Por exemplo, podemos fazer os programas dos execícios anteriores utilizarem um ORB OpenBus apenas trocando a chamada de \code{CORBA::init} para \code{ORBInitlializer::initORB}, como ilustrado na figura~\ref{fig:ex05:matrices/Server}.
Contudo, para tanto é necessário compilar o programa com as bibliotecas e ferramentas disponibilizadas pelo SDK.
Em particular, é necessário utilizar o compilador de IDL do SDK e as bibliotecas disponibilizadas.

\inputexsrc{ex05}{matrices/Server}{Servidor com ORB OpenBus.}

Para compilar a IDL \code{matrices.idl} utilizando o compilador de IDL do OpenBus SDK para Java utilize o seguinte comando:

\begin{samplecode}[language=bash]
java -cp $ODK_HOME/lib/jacorb-idl-compiler-3.4.jar org.jacorb.idl.parser matrices.idl
\end{samplecode}

Para compilar os programas para utilizarem a biblioteca de acesso, utilize o seguinte comando:

\begin{samplecode}[language=bash]
javac -cp "$ODK_HOME/lib/jacorb-3.4.jar\
:$ODK_HOME/lib/jacorb-omgapi-3.4.jar\
:$ODK_HOME/lib/openbus-sdk-core-2.0-SNAPSHOT.jar\
:$ODK_HOME/lib/openbus-sdk-legacy-2.0-SNAPSHOT.jar\
:$ODK_HOME/lib/scs-core-1.2.1.1.jar\
:$ODK_HOME/lib/slf4j-api-1.6.4.jar\
:$ODK_HOME/lib/slf4j-jdk14-1.6.4.jar" \
    tecgraf/openbus/demo/matrices/Server.java \
    tecgraf/openbus/demo/matrices/Application.java
\end{samplecode}

Por fim, para executar esses processos você pode fazer:

\begin{samplecode}[language=bash]
java -Djava.endorsed.dirs=$ODK_HOME/lib \
  tecgraf.openbus.demo.matrices.Server > ref.ior
java -Djava.endorsed.dirs=$ODK_HOME/lib \
  tecgraf.openbus.demo.matrices.Application < ref.ior
\end{samplecode}

Contudo, os programas agora devem lançar uma exceção de \code{CORBA::NO\_PERMISSION}.
Isso acontece porque um ORB OpenBus só permite chamadas através de um barramento, que só podem ser feitas após a autenticação da aplicação em nome de uma entidade.

O ORB OpenBus notifica diversas situações anômalas nas chamadas remotas através da exceção \code{CORBA::NO\_PERMSSION}, contendo códigos numéricos específicos que identificam o cenário exato da exceção, conforme ilustrado na tabela abaixo:

{\footnotesize
\begin{tabular}{l|c|c|r|l}
  Nome & Valor & vmcid & minor & Descrição \\
  \hline
  NoCredential      & 1112888070 & 0x42555000 & 774  & chamada feita sem credencial \\
  NoLogin           & 1112888319 & 0x42555000 & 1023 & sem conexão autenticada no barramento \\
  InvalidChain      & 1112888065 & 0x42555000 & 769  & cadeia de chamadas inválida \\
  InvalidPublicKey  & 1112888069 & 0x42555000 & 773  & alvo informou chave pública inválida \\
  InvalidRemote     & 1112888318 & 0x42555000 & 1022 & alvo não respeita o protocolo \\
  InvalidTarget     & 1112888316 & 0x42555000 & 1020 & alvo com login inválido \\
  UnavailableBus    & 1112888317 & 0x42555000 & 1021 & alvo sem acesso ao barramento \\
  UnknownBus        & 1112888068 & 0x42555000 & 772  & alvo está em outro barramento \\
  UnverifiedLogin   & 1112888067 & 0x42555000 & 771  & alvo não pôde verificar o login \\
\end{tabular}
}

Assim como a exceção \code{CORBA::NO\_PERMISSION}, as chamadas remotas de CORBA podem lançar outras exceções para indicar outras condições anômalas, tipicamente relacionadas a problemas de comunicação em rede, tais como listadas na tabela abaixo:

\begin{tabular}{l|l}
  Nome                      & Descrição \\
  \hline
  CORBA::UNKNOWN            & erro que não pode ser mapeado para CORBA \\
  \hline
  CORBA::OBJECT\_NOT\_EXIST & objeto referenciado não existe \\
  CORBA::TRANSIENT          & falha transiente, tente novamente \\
  CORBA::COMM\_FAILURE      & falha de comunicação \\
  \hline
  CORBA::MARSHAL            & erro na codificação dos valores \\
  CORBA::NO\_IMPLEMENT      & implementação da operação indisponível \\
  CORBA::BAD\_OPERATION     & operação chamada é inválida \\
  \hline
  CORBA::BAD\_INV\_ORDER    & invocação fora de ordem \\
  CORBA::BAD\_PARAM         & parâmetro inválido \\
\end{tabular}

\section{O Contexto OpenBus}

Todo ORB OpenBus tem associado um objeto especial denominado de contexto.
Esse objeto contexto permite definir informações de autenticação e identificação de chamadas para o contexto de execução atual.
O contexto de execução atual em geral se reflete na thread (linha de execução) atual do programa.
Basicamente utilizamos o contexto para definir a identidade com que as chamadas feitas usando a thread atual serão feitas através do barramento OpenBus.
O contexto OpenBus do ORB é obtido da seguinte forma:

\begin{samplecode}[language=java]
org.omg.CORBA.ORB orb = ORBInitializer.initORB();
tecgraf.openbus.OpenBusContext context =
  (tecgraf.openbus.OpenBusContext)
    orb.resolve_initial_references("OpenBusContext");
\end{samplecode}

Através do contexto criamos e manipular conexões com o barramento.
A interface do objeto de contexto do OpenBus é apresentada seguir:

\begin{samplecode}[language=java]
public interface OpenBusContext {
  ...
  Connection createConnection(String bus_host, int bus_port);
  Connection createConnection(String bus_host, int bus_port,
                              Properties props) throws InvalidPropertyValue;

  Connection setDefaultConnection(Connection conn);
  Connection getDefaultConnection();

  Connection setCurrentConnection(Connection conn);
  Connection getCurrentConnection();
  ...      
}
\end{samplecode}

\section{Manipulando Conexões}

A criação de novas conexões é feita através da operação \code{createConnection}, que recebe o endereço da máquina e o número da porta onde os serviços básicos daquele barramento executam.
Opicionalmente a operação \code{createConnection} recebe uma lista de propriedades que podem ser usadas para definir outros aspectos da conexão, tal como suporte à interoperabilidade com outros serviços que utilizem versões legadas do OpenBus e parâmetros de ajuste de desempenho.

Os objetos conexão são usados para representar formas de acesso a um barramento, que basicamente se resume a identidade com que se acessa o barramento.
Muitas vezes um dado sistema só cria uma única conexão e a utiliza para acessar o barramento sempre da mesma forma, ou seja, com a mesma identidade.
Nesse caso utilizamos a operação \code{setDefaultConnection} para definir a conexão padrão a ser utilizadas nas chamadas através daquele ORB.
Alternativamente, podemos usar a operação \code{setCurrentConnection} para definir uma conexão específica para o contexto atual (linha de execução), sobreescrevendo a conexão padrão para aquela linha de execução.

Para utilizarmos por padrão uma conexão para o barramento cujos serviços básicos executam na máquina \code{bushost} e na porta 20000, podemos utilizar o seguinte código:

\begin{samplecode}[language=java]
Connection conn = context.createConnection("host", 20000);
context.setDefaultConnection(conn);
\end{samplecode}

\section{Autenticação por Senha}

Para serem utilizadas na chamadas as conexões devem primeiramente serem autenticadas em nome de uma entidade.
Uma forma de fazer isso é através da operação \code{loginByPassword} da conexão, informando o nome da entidade e a senha.
Ao executar essa operação com sucesso, a conexão está autenticada e poderá ser usada para fazer chamadas usando como identidade o nome da entidade autenticada.
A seguir são apresentadas algumas das operações da conexão relacionadas a autenticação:

\begin{samplecode}[language=java]
public interface Connection {
  ...
  org.omg.CORBA.ORB orb();
  String busid();
  LoginInfo login();

  void loginByPassword(String entity, byte[] password) throws AlreadyLoggedIn,
                                                              AccessDenied,
                                                              ServiceFailure;

  boolean logout() throws ServiceFailure;
  ...
}
\end{samplecode}

A operação \code{logout} é usada para encerrar a autenticação da conexão e revogar o seu login, tornando inválidas todas as futuras chamadas pelo barramento utilizando essa identidade (login).
Enquanto a conexão estiver autenticada ela possui um login associado cuja informações podem ser obtiidas através da operação \code{login}.
Caso a conexão tenha sua autenticação (login) revogada ou nunca tenha sido autenticada, a operação \code{login} devolve um valor nulo.
A seguir é apresentado um trecho de código que se autentica no barramento com o nome de entidade \code{SomeoneUser} e imprime o identificador de login gerado no processo de autenticação.

\begin{samplecode}[language=java]
conn.loginByPassword("SomeoneUser", ("Someone").getBytes());
System.out.println("Meu login é "+conn.login().id);
conn.logout();
\end{samplecode}
